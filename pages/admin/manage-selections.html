<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Selections - ErgoSphere Admin</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22black%22/><circle cx=%2280%22 cy=%2220%22 r=%2212%22 fill=%22lime%22 opacity=%220.4%22/><circle cx=%2275%22 cy=%2225%22 r=%228%22 fill=%22lime%22/><circle cx=%2220%22 cy=%2280%22 r=%2212%22 fill=%22purple%22 opacity=%220.4%22/><circle cx=%2225%22 cy=%2275%22 r=%228%22 fill=%22purple%22/></svg>" />
  <style>
    .admin-form {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #0ff;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #0ff;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 4px;
    }
    
    .form-group select {
      height: 36px;
    }
    
    .submit-btn {
      background-color: #f0f;
      border: none;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
      transition: all 0.3s;
    }
    
    .submit-btn:hover {
      background-color: #d0d;
      transform: translateY(-2px);
    }
    
    .notification {
      padding: 10px;
      margin: 15px 0;
      border-radius: 4px;
      display: none;
    }
    
    .success {
      background-color: rgba(0, 255, 0, 0.2);
      border: 1px solid #0f0;
      color: #0f0;
    }
    
    .error {
      background-color: rgba(255, 0, 0, 0.2);
      border: 1px solid #f00;
      color: #f00;
    }

    .preview-card {
      border: 1px solid #0ff;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 5px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .preview-title {
      color: #0ff;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      margin-bottom: 10px;
    }
      .preview-content {
      color: white;
      text-align: center;
      font-size: 1.2em;
    }
    
    .last-updated {
      font-size: 0.9em;
      color: #888;
      margin-top: 20px;
      border-top: 1px solid rgba(0,255,255,0.2);
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <nav id="navbar">
    <button><a href="../../index.html">HOME</a></button>
    <button><a href="../ErgoShop.html">ErgoShop</a></button>
    <button><a href="../MODS.html">MODS</a></button>
    <button><a href="../casino.html">CASINO</a></button>
    <button><a href="../scoreboard.html">SCOREBOARD</a></button>
    <button><a href="../contracts.html">CONTRACTS</a></button>
  </nav>

  <hr>
  <header>
    <h1>ErgoSphere Admin</h1>
  </header>
  <hr>

  <main id="main-content">
    <div class="cyber-panel admin-form">
      <h2 class="cyber-title">Manage Weekly Selections</h2>
      
      <div id="notification" class="notification"></div>
      
      <form id="selectionsForm">
        <div class="form-group">
          <label for="bingwaChampion">Bingwa Champion:</label>
          <select id="bingwaChampion" name="bingwaChampion" required>
            <option value="JAYBERS8">JAYBERS8</option>
            <option value="FLIGHTx12!">FLIGHTx12!</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="atleticoChamp">Atletico Champion:</label>
          <select id="atleticoChamp" name="atleticoChamp" required>
            <option value="FLIGHTx12!">FLIGHTx12!</option>
            <option value="JAYBERS8">JAYBERS8</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="movieNight">Movie Night Selection:</label>
          <select id="movieNight" name="movieNight" required>
            <option value="Loading...">Loading...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="banquetMeal">Bingwa Banquet Meal:</label>
          <select id="banquetMeal" name="banquetMeal" required>
            <option value="Loading...">Loading...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="bingwaBrunch">Bingwa Brunch:</label>
          <select id="bingwaBrunch" name="bingwaBrunch" required>
            <option value="Loading...">Loading...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="youtubeTheater1">YouTube Theater Selection:</label>
          <select id="youtubeTheater1" name="youtubeTheater1" required>
            <option value="">-- Select Video 1 --</option>
          </select>
          <select id="youtubeTheater2" name="youtubeTheater2">
            <option value="">-- Select Video 2 (optional) --</option>
          </select>
          <select id="youtubeTheater3" name="youtubeTheater3">
            <option value="">-- Select Video 3 (optional) --</option>
          </select>
          <div id="youtube-runtime-warning" style="color:#f00; display:none; font-size:0.95em; margin-top:4px;"></div>
        </div>
        
        <button type="submit" class="submit-btn">Update Selections</button>        
        <div class="preview-card">
          <div class="preview-title">Preview</div>
          <div class="preview-content">
            <p><strong>Bingwa Champion:</strong> <span id="preview-bingwa"></span></p>
            <p><strong>Atletico Champion:</strong> <span id="preview-atletico"></span></p>
            <p><strong>Movie Night:</strong> <span id="preview-movie"></span></p>
            <p><strong>Bingwa Banquet:</strong> <span id="preview-banquet"></span></p>
            <p><strong>Bingwa Brunch:</strong> <span id="preview-brunch"></span></p>
            <p><strong>YouTube Theater:</strong> <span id="preview-youtube"></span></p>
            <p class="last-updated"><em>Last updated: <span id="last-updated">Never</span></em></p>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load movie options from movies.json
      fetch('../../data/movies.json')
        .then(response => {
          // Remove comments from JSON file if they exist
          return response.text().then(text => {
            // Remove any comments that start with //
            const jsonString = text.replace(/^\s*\/\/.*$/gm, '');
            try {
              return JSON.parse(jsonString);
            } catch (e) {
              console.error('Error parsing JSON:', e);
              throw e;
            }
          });
        })
        .then(data => {
          const movieSelect = document.getElementById('movieNight');
          // Clear the loading option
          movieSelect.innerHTML = '';
          
          // Add only movies with STATUS of ðŸŸ¢ to the select dropdown
          data.forEach(movie => {
            if (movie.Title && movie.STATUS === "ðŸŸ¢") {
              const option = document.createElement('option');
              option.value = movie.Title;
              option.textContent = movie.Title;
              movieSelect.appendChild(option);
            }
          });
          
          // Now load meal options from meals.json
          return fetch('../../data/meals.json');
        })
        .then(response => {
          return response.text().then(text => {
            const jsonString = text.replace(/^\s*\/\/.*$/gm, '');
            try {
              return JSON.parse(jsonString);
            } catch (e) {
              console.error('Error parsing meals JSON:', e);
              throw e;
            }
          });
        })
        .then(data => {
          const banquetSelect = document.getElementById('banquetMeal');
          const brunchSelect = document.getElementById('bingwaBrunch');
          // Clear the loading option
          banquetSelect.innerHTML = '';
          brunchSelect.innerHTML = '';
          // Add all meal options to the banquet dropdown
          data.forEach(meal => {
            const option = document.createElement('option');
            option.value = meal.meal;
            option.textContent = meal.meal;
            banquetSelect.appendChild(option);
          });
          // Add only Bingwa Brunch options to the brunch dropdown
          data.filter(meal => meal.mealType === 'bingwa_brunch').forEach(meal => {
            const option = document.createElement('option');
            option.value = meal.meal;
            option.textContent = meal.meal;
            brunchSelect.appendChild(option);
          });
          // Now load YouTube options from youtube.json
          return fetch('../../data/youtube.json');
        })
        .then(response => {
          return response.text().then(text => {
            const jsonString = text.replace(/^\s*\/\/.*$/gm, '');
            try {
              return JSON.parse(jsonString);
            } catch (e) {
              console.error('Error parsing youtube JSON:', e);
              throw e;
            }
          });
        })
        .then(data => {
          const yt1 = document.getElementById('youtubeTheater1');
          const yt2 = document.getElementById('youtubeTheater2');
          const yt3 = document.getElementById('youtubeTheater3');
          [yt1, yt2, yt3].forEach(select => {
            select.innerHTML = `<option value="">-- Select Video${select === yt1 ? ' 1' : select === yt2 ? ' 2 (optional)' : ' 3 (optional)'} --</option>`;
            data.forEach(video => {
              if (video.TITLE && video.STATUS === 'ðŸŸ¢') {
                const option = document.createElement('option');
                let label = video.TITLE + (video.RUNTIME ? ` (${video.RUNTIME})` : '');
                if (video["TIMES SEEN"] && video["TIMES SEEN"].includes('ðŸ‘€')) {
                  label += ' ðŸ‘€';
                }
                option.value = video.TITLE;
                option.textContent = label;
                option.setAttribute('data-runtime', video.RUNTIME || '0:00');
                select.appendChild(option);
              }
            });
          });
          loadCurrentSelections();
        })
        .catch(error => {
          console.error('Error loading data:', error);
          document.getElementById('movieNight').innerHTML = '<option value="Error">Error loading movies</option>';
          document.getElementById('banquetMeal').innerHTML = '<option value="Error">Error loading meals</option>';
        });

      // Form submission
      document.getElementById('selectionsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const bingwaChampion = document.getElementById('bingwaChampion').value;
        const atleticoChamp = document.getElementById('atleticoChamp').value;
        const movieNight = document.getElementById('movieNight').value;
        const banquetMeal = document.getElementById('banquetMeal').value;
        const brunchMeal = document.getElementById('bingwaBrunch').value;
        const youtubeTheater = [
          document.getElementById('youtubeTheater1').value,
          document.getElementById('youtubeTheater2').value,
          document.getElementById('youtubeTheater3').value
        ].filter(Boolean);
        
        // Show loading state
        const submitBtn = this.querySelector('.submit-btn');
        const originalBtnText = submitBtn.textContent;
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;
        
        if (!checkYouTubeRuntimeLimit()) {
          e.preventDefault();
          return;
        }

        // Update server via API
        fetch('/api/selections', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            bingwaChampion,
            atleticoChamp,
            movieNight,
            banquetMeal,
            brunchMeal,
            youtubeTheater
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          showNotification('Selections updated successfully!', 'success');
          updatePreview();
          
          // Reset button state
          submitBtn.textContent = originalBtnText;
          submitBtn.disabled = false;
        })
        .catch(error => {
          console.error('Error updating selections:', error);
          showNotification('Error updating selections. Please try again.', 'error');
          
          // Reset button state
          submitBtn.textContent = originalBtnText;
          submitBtn.disabled = false;
        });
      });

      // Update preview when selection changes
      document.getElementById('bingwaChampion').addEventListener('change', updatePreview);
      document.getElementById('atleticoChamp').addEventListener('change', updatePreview);
      document.getElementById('movieNight').addEventListener('change', updatePreview);
      document.getElementById('banquetMeal').addEventListener('change', updatePreview);
      document.getElementById('bingwaBrunch').addEventListener('change', updatePreview);
      ['youtubeTheater1','youtubeTheater2','youtubeTheater3'].forEach(id => {
        document.getElementById(id).addEventListener('change', function() {
          updatePreview();
          checkYouTubeRuntimeLimit();
          updateYouTubeDropdowns();
        });
      });

      function loadCurrentSelections() {
        // Fetch current selections from server
        fetch('/api/selections')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(ergosphereData => {
            if (ergosphereData.bingwaChampion) {
              document.getElementById('bingwaChampion').value = ergosphereData.bingwaChampion;
            }
            
            if (ergosphereData.atleticoChamp) {
              document.getElementById('atleticoChamp').value = ergosphereData.atleticoChamp;
            }
            
            if (ergosphereData.movieNight) {
              const movieSelect = document.getElementById('movieNight');
              // Try to find and select the stored movie
              let found = false;
              
              for (let i = 0; i < movieSelect.options.length; i++) {
                if (movieSelect.options[i].value === ergosphereData.movieNight) {
                  movieSelect.value = ergosphereData.movieNight;
                  found = true;
                  break;
                }
              }
              
              // If not found, add it as an option
              if (!found && ergosphereData.movieNight) {
                const option = document.createElement('option');
                option.value = ergosphereData.movieNight;
                option.textContent = ergosphereData.movieNight;
                movieSelect.appendChild(option);
                movieSelect.value = ergosphereData.movieNight;
              }
            }

            // Handle banquet meal selection
            if (ergosphereData.banquetMeal) {
              const banquetSelect = document.getElementById('banquetMeal');
              let found = false;
              
              for (let i = 0; i < banquetSelect.options.length; i++) {
                if (banquetSelect.options[i].value === ergosphereData.banquetMeal) {
                  banquetSelect.value = ergosphereData.banquetMeal;
                  found = true;
                  break;
                }
              }
              
              // If not found, add it as an option
              if (!found && ergosphereData.banquetMeal) {
                const option = document.createElement('option');
                option.value = ergosphereData.banquetMeal;
                option.textContent = ergosphereData.banquetMeal;
                banquetSelect.appendChild(option);
                banquetSelect.value = ergosphereData.banquetMeal;
              }
            }

            // Handle brunch meal selection
            if (ergosphereData.brunchMeal) {
              const brunchSelect = document.getElementById('bingwaBrunch');
              let found = false;
              
              for (let i = 0; i < brunchSelect.options.length; i++) {
                if (brunchSelect.options[i].value === ergosphereData.brunchMeal) {
                  brunchSelect.value = ergosphereData.brunchMeal;
                  found = true;
                  break;
                }
              }
              
              // If not found, add it as an option
              if (!found && ergosphereData.brunchMeal) {
                const option = document.createElement('option');
                option.value = ergosphereData.brunchMeal;
                option.textContent = ergosphereData.brunchMeal;
                brunchSelect.appendChild(option);
                brunchSelect.value = ergosphereData.brunchMeal;
              }
            }

            // Handle YouTube Theater selection
            if (ergosphereData.youtubeTheater) {
              const yt1 = document.getElementById('youtubeTheater1');
              const yt2 = document.getElementById('youtubeTheater2');
              const yt3 = document.getElementById('youtubeTheater3');
              const selected = ergosphereData.youtubeTheater;
              [yt1, yt2, yt3].forEach((select, idx) => {
                if (selected[idx]) {
                  let found = false;
                  for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === selected[idx]) {
                      select.value = selected[idx];
                      found = true;
                      break;
                    }
                  }
                  if (!found) {
                    const option = document.createElement('option');
                    option.value = selected[idx];
                    option.textContent = selected[idx];
                    select.appendChild(option);
                    select.value = selected[idx];
                  }
                }
              });
            }
            
            // Update last updated time if available
            if (ergosphereData.lastUpdated) {
              const lastUpdated = new Date(ergosphereData.lastUpdated);
              document.getElementById('last-updated').textContent = lastUpdated.toLocaleString();
            }

            updatePreview();
          })
          .catch(error => {
            console.error('Error loading selections:', error);
            showNotification('Error loading current selections', 'error');
          });
      }
      
      function updatePreview() {
        document.getElementById('preview-bingwa').textContent = document.getElementById('bingwaChampion').value;
        document.getElementById('preview-atletico').textContent = document.getElementById('atleticoChamp').value;
        document.getElementById('preview-movie').textContent = document.getElementById('movieNight').value;
        document.getElementById('preview-banquet').textContent = document.getElementById('banquetMeal').value;
        document.getElementById('preview-brunch').textContent = document.getElementById('bingwaBrunch').value;
        const yt1 = document.getElementById('youtubeTheater1');
        const yt2 = document.getElementById('youtubeTheater2');
        const yt3 = document.getElementById('youtubeTheater3');
        const selected = [yt1, yt2, yt3].map(select => {
          if (select.value) {
            const runtime = select.selectedOptions[0]?.getAttribute('data-runtime') || '';
            return select.value + (runtime ? ` (${runtime})` : '');
          }
          return null;
        }).filter(Boolean);
        document.getElementById('preview-youtube').textContent = selected.length ? selected.join(', ') : 'None';
        // Show total runtime in preview
        let totalSeconds = 0;
        [yt1, yt2, yt3].forEach(select => {
          const runtime = select.selectedOptions[0]?.getAttribute('data-runtime') || '0:00';
          if (select.value) {
            const match = runtime.match(/(\d+):(\d+)/);
            if (match) {
              totalSeconds += parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
            }
          }
        });
        if (selected.length) {
          const mins = Math.floor(totalSeconds / 60);
          const secs = totalSeconds % 60;
          document.getElementById('preview-youtube').textContent += ` (Total: ${mins}:${secs.toString().padStart(2, '0')})`;
        }
      }
      
      function checkYouTubeRuntimeLimit() {
        const yt1 = document.getElementById('youtubeTheater1');
        const yt2 = document.getElementById('youtubeTheater2');
        const yt3 = document.getElementById('youtubeTheater3');
        const warning = document.getElementById('youtube-runtime-warning');
        let totalSeconds = 0;
        [yt1, yt2, yt3].forEach(select => {
          const runtime = select.selectedOptions[0]?.getAttribute('data-runtime') || '0:00';
          if (select.value) {
            const match = runtime.match(/(\d+):(\d+)/);
            if (match) {
              totalSeconds += parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
            }
          }
        });
        if (totalSeconds > 3660) { // 1 hour 1 minute = 3660 seconds
          warning.style.display = 'block';
          warning.textContent = 'Total runtime must be under 1 hour 1 minute (01:01:00). Please remove some selections.';
          return false;
        } else {
          warning.style.display = 'none';
          warning.textContent = '';
          return true;
        }
      }
      
      function updateYouTubeDropdowns() {
        // Prevent duplicate selections
        const yt1 = document.getElementById('youtubeTheater1');
        const yt2 = document.getElementById('youtubeTheater2');
        const yt3 = document.getElementById('youtubeTheater3');
        const selected = [yt1.value, yt2.value, yt3.value].filter(Boolean);
        [yt1, yt2, yt3].forEach((select, idx) => {
          Array.from(select.options).forEach(opt => {
            if (opt.value && selected.includes(opt.value) && select.value !== opt.value) {
              opt.disabled = true;
            } else {
              opt.disabled = false;
            }
          });
        });
      }
      
      function showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = 'notification ' + type;
        notification.style.display = 'block';
        
        setTimeout(() => {
          notification.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>
</html>
