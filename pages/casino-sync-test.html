<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Sync Test</title>
    <style>        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }        /* Link for the connection status indicator */
        .connection-status-link {
            text-decoration: none;
            display: block;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            cursor: pointer;
        }
        
        .connection-status-link:hover .connection-status-compact {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
        }
        
        /* Compact connection status in corner */
        .connection-status-compact {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(42, 42, 42, 0.8);
            backdrop-filter: blur(2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .connection-status-compact:hover {
            background-color: rgba(42, 42, 42, 0.95);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .connection-status-compact.connected .status-dot { background-color: #4CAF50; }
        .connection-status-compact.disconnected .status-dot { background-color: #F44336; }
        .connection-status-compact.connecting .status-dot { background-color: #FF9800; }
        
        .status-panel {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        /* Keep the old connection status for backward compatibility */
        .connection-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .connected { background-color: #2d5a2d; }
        .disconnected { background-color: #5a2d2d; }
        .connecting { background-color: #5a5a2d; }
        .log-entry {
            background: #333;
            border-left: 3px solid #666;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 0 4px 4px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry.info { border-left-color: #4CAF50; }
        .log-entry.warn { border-left-color: #FF9800; }
        .log-entry.error { border-left-color: #F44336; }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #555;
        }
        button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 15px;
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
        /* Added style for the custom message textarea */
        .test-buttons textarea {
            width: 100%;
            box-sizing: border-box; /* Ensures padding and border are included in the width */
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #666;
            background-color: #333;
            color: #fff;
            font-family: 'Courier New', monospace;
            resize: vertical; /* Allows vertical resizing */
        }
    </style>
</head>
<body>    <h1>ðŸŽ° Casino Real-Time Sync Test</h1>    <!-- Compact connection status indicator in corner -->
    <a href="casino.html" title="Return to Casino page" class="connection-status-link">
        <div id="connection-status" class="connection-status-compact disconnected">
            <span class="status-dot"></span>
            <span class="status-text">Offline</span>
        </div>
    </a>
    
    <!-- Stats panel -->
    <div class="status-panel">
        <h2>Connection Statistics</h2>
        <div class="stats">
            <div class="stat-item">
                <div id="messages-sent" class="stat-value">0</div>
                <div class="stat-label">Messages Sent</div>
            </div>
            <div class="stat-item">
                <div id="messages-received" class="stat-value">0</div>
                <div class="stat-label">Messages Received</div>
            </div>
            <div class="stat-item">
                <div id="uptime" class="stat-value">0s</div>
                <div class="stat-label">Connection Uptime</div>
            </div>
            <div class="stat-item">
                <div id="reconnects" class="stat-value">0</div>
                <div class="stat-label">Reconnections</div>
            </div>
        </div>
    </div>
    
    <div class="status-panel">
        <h2>Test Actions</h2>
        <div class="test-buttons">
            <button onclick="connectSync()">Connect</button>
            <button onclick="disconnectSync()">Disconnect</button>
            <button onclick="sendPing()">Send Ping</button>
            <button onclick="simulateBetCreated()">Simulate Bet Created</button>
            <button onclick="simulateBetUpdated()">Simulate Bet Updated</button>
            <button onclick="simulateBetDeleted()">Simulate Bet Deleted</button>
            <button onclick="clearLog()">Clear Log</button>
            <!-- New elements for sending custom message -->
            <textarea id="custom-message-input" placeholder="Enter JSON message to send (e.g., {&quot;type&quot;:&quot;echo&quot;,&quot;payload&quot;:&quot;hello&quot;})" rows="3"></textarea>
            <button onclick="sendCustomMessage()" style="margin-top: 5px;">Send Custom Message</button>
        </div>
    </div>
    
    <div class="status-panel">
        <h2>Event Log</h2>
        <div id="event-log" style="max-height: 400px; overflow-y: auto;">
            <!-- Log entries will appear here -->
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/casino-sync.js"></script>
    <script>
        let syncManager = null;
        let stats = {
            messagesSent: 0,
            messagesReceived: 0,
            reconnects: 0,
            connectedAt: null
        };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Keep only last 50 entries
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }        function updateConnectionStatus(status, message) {
            // Update the compact status indicator
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status-compact ${status}`;
            
            // Create shortened messages
            let shortMessage = message;
            if (message.includes('Connected')) shortMessage = 'Online';
            else if (message.includes('Disconnect')) shortMessage = 'Offline';  
            else if (message.includes('Connect')) shortMessage = 'Syncing';
            else if (message.includes('Error')) shortMessage = 'Error';
            
            // Update the dot and text separately
            const textSpan = statusEl.querySelector('.status-text');
            if (textSpan) {
                textSpan.textContent = shortMessage;
            } else {
                // If elements don't exist yet, rebuild the content
                statusEl.innerHTML = `
                    <span class="status-dot"></span>
                    <span class="status-text">${shortMessage}</span>
                `;
            }
        }
        
        function updateStats() {
            document.getElementById('messages-sent').textContent = stats.messagesSent;
            document.getElementById('messages-received').textContent = stats.messagesReceived;
            document.getElementById('reconnects').textContent = stats.reconnects;
            
            if (stats.connectedAt) {
                const uptime = Math.floor((Date.now() - stats.connectedAt) / 1000);
                document.getElementById('uptime').textContent = uptime + 's';
            } else {
                document.getElementById('uptime').textContent = '0s';
            }
        }
        
        function connectSync() {
            if (syncManager) {
                log('Sync manager already exists', 'warn');
                return;
            }
            
            try {
                syncManager = new CasinoSyncManager();
                
                // Override notification methods for testing
                syncManager.showNotification = function(message, type = 'info') {
                    log(`NOTIFICATION: ${message}`, type);
                    stats.messagesReceived++;
                    updateStats();
                };
                
                // Override connection callbacks for testing
                const originalOnOpen = syncManager.onWebSocketOpen.bind(syncManager);
                syncManager.onWebSocketOpen = function() {
                    originalOnOpen();
                    updateConnectionStatus('connected', 'Connected via WebSocket');
                    stats.connectedAt = Date.now();
                    log('WebSocket connection established', 'info');
                    updateStats();
                };
                
                const originalOnClose = syncManager.onWebSocketClose.bind(syncManager);
                syncManager.onWebSocketClose = function() {
                    originalOnClose();
                    updateConnectionStatus('disconnected', 'Disconnected');
                    stats.connectedAt = null;
                    log('WebSocket connection closed', 'warn');
                    updateStats();
                };
                
                const originalOnError = syncManager.onWebSocketError.bind(syncManager);
                syncManager.onWebSocketError = function(error) {
                    originalOnError(error);
                    updateConnectionStatus('disconnected', 'Connection Error');
                    log('WebSocket error: ' + error.message, 'error');
                    updateStats();
                };
                
                const originalOnMessage = syncManager.onWebSocketMessage.bind(syncManager);
                syncManager.onWebSocketMessage = function(data) {
                    originalOnMessage(data);
                    stats.messagesReceived++;
                    log('Received: ' + JSON.stringify(data), 'info');
                    updateStats();
                };
                
                // Track reconnections
                const originalReconnect = syncManager.reconnect.bind(syncManager);
                syncManager.reconnect = function() {
                    stats.reconnects++;
                    log('Attempting to reconnect...', 'warn');
                    updateStats();
                    return originalReconnect();
                };
                
                updateConnectionStatus('connecting', 'Connecting...');
                syncManager.connect();
                log('Attempting to connect to sync manager', 'info');
            } catch (error) {
                log('Error creating sync manager: ' + error.message, 'error');
                updateConnectionStatus('disconnected', 'Connection Failed');
            }
        }
        
        function disconnectSync() {
            if (syncManager) {
                syncManager.disconnect();
                syncManager = null;
                updateConnectionStatus('disconnected', 'Disconnected');
                stats.connectedAt = null;
                log('Disconnected from sync manager', 'info');
                updateStats();
            } else {
                log('No active connection to disconnect', 'warn');
            }
        }
        
        function sendPing() {
            if (syncManager && syncManager.isConnected()) {
                syncManager.ws.send(JSON.stringify({ 
                    type: 'ping', 
                    timestamp: new Date().toISOString() 
                }));
                stats.messagesSent++;
                log('Sent ping message', 'info');
                updateStats();
            } else {
                log('Cannot send ping - not connected', 'warn');
            }
        }
        
        function simulateBetCreated() {
            if (syncManager) {
                const fakeMessage = {
                    type: 'bet_created',
                    data: {
                        id: 'test-' + Date.now(),
                        user_name: 'TestUser',
                        league: 'NFL',
                        away_team: 'Team A',
                        home_team: 'Team B'
                    },
                    weekKey: getCurrentWeekKey(),
                    timestamp: new Date().toISOString()
                };
                syncManager.onWebSocketMessage(fakeMessage);
                log('Simulated bet_created message', 'info');
            } else {
                log('No sync manager available', 'warn');
            }
        }
        
        function simulateBetUpdated() {
            if (syncManager) {
                const fakeMessage = {
                    type: 'bet_updated',
                    data: {
                        id: 'test-' + Date.now(),
                        user_name: 'TestUser',
                        bet_status: { 0: 'won', 1: 'lost' }
                    },
                    weekKey: getCurrentWeekKey(),
                    updateType: 'status',
                    timestamp: new Date().toISOString()
                };
                syncManager.onWebSocketMessage(fakeMessage);
                log('Simulated bet_updated message', 'info');
            } else {
                log('No sync manager available', 'warn');
            }
        }
        
        function simulateBetDeleted() {
            if (syncManager) {
                const fakeMessage = {
                    type: 'bet_deleted',
                    data: {
                        id: 'test-' + Date.now(),
                        user_name: 'TestUser'
                    },
                    weekKey: getCurrentWeekKey(),
                    timestamp: new Date().toISOString()
                };
                syncManager.onWebSocketMessage(fakeMessage);
                log('Simulated bet_deleted message', 'info');
            } else {
                log('No sync manager available', 'warn');
            }
        }

        // New function to send a custom JSON message
        function sendCustomMessage() {
            if (syncManager && syncManager.isConnected()) {
                const messageInput = document.getElementById('custom-message-input');
                const messageString = messageInput.value.trim();
                if (!messageString) {
                    log('Custom message input is empty. Please enter a JSON message.', 'warn');
                    return;
                }
                try {
                    // Validate JSON format client-side before sending
                    JSON.parse(messageString); 
                    syncManager.ws.send(messageString); // Send the raw string
                    stats.messagesSent++;
                    log('Sent custom message: ' + messageString, 'info');
                    updateStats();
                    // messageInput.value = ''; // Optionally clear input after sending
                } catch (error) {
                    log('Error sending custom message: Invalid JSON format. ' + error.message, 'error');
                }
            } else {
                log('Cannot send custom message - not connected', 'warn');
            }
        }
        
        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
            log('Log cleared', 'info');
        }
        
        // Utility function (from casino.js)
        function getCurrentWeekKey() {
            const now = new Date();
            const sunday = new Date(now);
            const dayOfWeek = now.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 0 : dayOfWeek;
            sunday.setDate(now.getDate() - daysToSubtract);
            
            const year = sunday.getFullYear();
            const month = String(sunday.getMonth() + 1).padStart(2, '0');
            const day = String(sunday.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // Update stats every second
        setInterval(updateStats, 1000);
        
        // Auto-connect on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('Casino Sync Test loaded', 'info');
            setTimeout(connectSync, 1000); // Connect after 1 second
        });
    </script>
</body>
</html>
